<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎭 Perfil Cultural - RPGStack</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Cinzel:wght@400;500;600&family=Dancing+Script:wght@500;600&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* CSS Variables - Éclat Mystique Theme */
        :root {
            --gold-primary: #D4AF37;
            --gold-light: #F7E98E;
            --gold-dark: #B8860B;
            --burgundy: #722F37;
            --burgundy-light: #8B4B5C;
            --burgundy-dark: #5A252A;
            --emerald: #355E3B;
            --emerald-light: #4A7C59;
            --emerald-dark: #2A4A30;
            --parchment: #FDF5E6;
            --sepia-base: #F5F5DC;
            --aged-paper: #F0E68C;
            --charcoal: #36454F;
        }
        
        /* Base Styles */
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #36454F 0%, #722F37 50%, #355E3B 100%);
            min-height: 100vh;
            color: #FDF5E6;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(253, 245, 230, 0.98);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: #36454F;
            overflow: hidden;
            position: relative;
        }
        
        /* Navigation */
        .nav-bar {
            background: linear-gradient(135deg, #722F37 0%, #5A252A 100%);
            color: #F7E98E;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-button {
            background: #D4AF37;
            color: #36454F;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            background: #F7E98E;
            transform: translateY(-2px);
        }
        
        /* Loading & Error States */
        .loading, .error {
            text-align: center;
            padding: 100px 20px;
            font-size: 1.2em;
        }
        
        .loading {
            color: #722F37;
        }
        
        .error {
            color: #8B4B5C;
        }
        
        /* Character Profile */
        .profile-header {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(53, 94, 59, 0.1) 100%);
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        .profile-ornament {
            font-size: 2em;
            color: #D4AF37;
            margin-bottom: 20px;
        }
        
        .character-name {
            font-family: 'Playfair Display', serif;
            font-size: 3em;
            font-weight: 700;
            color: #722F37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        
        .character-subtitle {
            font-family: 'Dancing Script', cursive;
            font-size: 1.5em;
            color: #355E3B;
            margin-bottom: 20px;
        }
        
        .character-tags {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .tag {
            background: #722F37;
            color: #F7E98E;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .tag.culture {
            background: #355E3B;
        }
        
        .tag.level {
            background: #D4AF37;
            color: #36454F;
        }
        
        /* Profile Content */
        .profile-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
        }
        
        /* Stats Panel */
        .stats-panel {
            background: #FDF5E6;
            border: 2px solid #D4AF37;
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
        }
        
        .stats-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            font-weight: 600;
            color: #722F37;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            border-left: 3px solid #D4AF37;
            margin-bottom: 10px;
        }
        
        .stat-name {
            font-weight: 500;
            color: #2A4A30;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #722F37;
            font-size: 1.1em;
        }
        
        /* Skills Panel */
        .skills-panel {
            background: #FDF5E6;
            border: 2px solid #355E3B;
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
            margin-top: 20px;
        }
        
        /* Artifact Section */
        .artifact-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        }
        
        .artifact-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2em;
            font-weight: 600;
            color: #722F37;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .artifact-passive {
            background: rgba(114, 47, 55, 0.1);
            border-left: 4px solid #722F37;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .passive-name {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #722F37;
            font-size: 1.05em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .passive-description {
            color: #36454F;
            font-size: 0.9em;
            line-height: 1.5;
            font-style: italic;
        }
        
        /* Cultural Elements Section */
        .cultural-elements-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2em;
            font-weight: 600;
            color: #355E3B;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .skill-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: rgba(53, 94, 59, 0.1);
            border-radius: 10px;
            border-left: 3px solid #355E3B;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .skill-item:hover {
            background: rgba(53, 94, 59, 0.15);
            transform: translateX(5px);
        }
        
        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .skill-name {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #2A4A30;
            font-size: 1.05em;
        }
        
        .skill-damage {
            background: #722F37;
            color: #F7E98E;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .skill-description {
            color: #36454F;
            font-size: 0.9em;
            line-height: 1.4;
            font-style: italic;
            margin-top: 5px;
        }
        
        .no-skills {
            text-align: center;
            color: #8B4B5C;
            font-style: italic;
            padding: 20px;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .content-section {
            background: #FDF5E6;
            border: 2px solid #D4AF37;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        
        .content-section::before {
            content: '◊';
            position: absolute;
            top: 15px;
            right: 20px;
            color: #D4AF37;
            font-size: 1.5em;
            opacity: 0.3;
        }
        
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4em;
            font-weight: 600;
            color: #722F37;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 10px;
        }
        
        .section-content {
            color: #36454F;
            line-height: 1.7;
            font-size: 1.05em;
        }
        
        .section-content p {
            margin-bottom: 15px;
        }
        
        .section-content h3 {
            font-family: 'Playfair Display', serif;
            color: #722F37;
            margin: 20px 0 10px 0;
            font-size: 1.2em;
        }
        
        .section-content h4 {
            font-family: 'Cinzel', serif;
            color: #355E3B;
            margin: 15px 0 8px 0;
            font-size: 1.1em;
        }
        
        .section-content ul, .section-content ol {
            margin: 10px 0 15px 25px;
        }
        
        .section-content li {
            margin-bottom: 5px;
        }
        
        .section-content strong {
            color: #722F37;
            font-weight: 600;
        }
        
        .section-content em {
            color: #355E3B;
            font-style: italic;
        }
        
        /* Skills Section */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .skill-card {
            background: rgba(114, 47, 55, 0.1);
            border: 1px solid #8B4B5C;
            border-radius: 10px;
            padding: 20px;
        }
        
        .skill-name {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #722F37;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        .skill-description {
            color: #36454F;
            line-height: 1.6;
        }
        
        /* Artefato Section */
        .artefato-card {
            background: rgba(53, 94, 59, 0.1);
            border: 2px solid #355E3B;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
        }
        
        .artefato-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            font-weight: 600;
            color: #2A4A30;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .character-name {
                font-size: 2.5em;
            }
        }
        
        @media (max-width: 768px) {
            .character-name {
                font-size: 2em;
            }
            
            .nav-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .sidebar {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .profile-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
        }
        
        /* Markdown Content Styling */
        .markdown-content {
            line-height: 1.8;
        }
        
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3 {
            font-family: 'Playfair Display', serif;
            color: #722F37;
            margin: 25px 0 15px 0;
        }
        
        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 3px solid #D4AF37;
            padding-bottom: 10px;
        }
        
        .markdown-content h2 {
            font-size: 1.5em;
            color: #355E3B;
        }
        
        .markdown-content h3 {
            font-size: 1.3em;
        }
        
        .markdown-content blockquote {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid #D4AF37;
            padding: 15px 20px;
            margin: 20px 0;
            font-style: italic;
            color: #355E3B;
        }
        
        .markdown-content code {
            background: rgba(53, 94, 59, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #2A4A30;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <div class="nav-title">🎭 Perfil Cultural - Chronos</div>
            <div class="nav-buttons">
                <a href="/cultural-characters/" class="nav-button">
                    ← Lista de Personagens
                </a>
                <a href="/" class="nav-button">
                    🏠 Menu Principal
                </a>
            </div>
        </div>
        
        <div id="profileContainer">
            <div class="loading">
                🔄 Carregando perfil cultural...
            </div>
        </div>
        
        <!-- Botão de Teste Temporário -->
        <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
            <button onclick="testSkillsAPI()" style="background: #722F37; color: #F7E98E; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer;">
                🔧 Testar Skills API
            </button>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        let characterData = null;
        
        // Função de teste para debugging
        async function testSkillsAPI() {
            console.log('🧪 === TESTE DA API DE SKILLS ===');
            
            try {
                const response = await fetch('/api/skills', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    cache: 'no-cache'
                });
                
                console.log('🌐 Response status:', response.status);
                console.log('🌐 Response headers:', Array.from(response.headers.entries()));
                
                const data = await response.json();
                console.log('📦 Skills API Response:', JSON.stringify(data, null, 2));
                
                const skills = data?.data?.skills || [];
                console.log('🎯 Skills array length:', skills.length);
                console.log('🆔 IDs encontrados:', skills.map(s => s.id));
                
                // Testar busca específica
                const shiSkills = skills.filter(s => s.id.startsWith('SHIWX'));
                console.log('⚔️ Skills do Shi Wuxing:', shiSkills.length);
                shiSkills.forEach(skill => {
                    console.log(`   - ${skill.id}: ${skill.name}`);
                });
                
                alert(`Teste completo! Encontradas ${skills.length} skills total, ${shiSkills.length} do Shi Wuxing. Veja o console para detalhes.`);
                
            } catch (error) {
                console.error('💥 Erro no teste:', error);
                alert('Erro no teste: ' + error.message);
            }
        }
        
        // Função para obter ID do personagem da URL
        function getCharacterIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Função para carregar dados do personagem
        async function loadCharacter(characterId) {
            try {
                console.log('Carregando personagem:', characterId);
                const response = await fetch(`${API_BASE}/characters`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dados completos carregados:', data);
                
                // Procurar personagem por ID
                characterData = null;
                if (data.characters) {
                    characterData = data.characters[characterId];
                }
                
                if (!characterData) {
                    throw new Error('Personagem não encontrado no banco de dados');
                }
                
                console.log('Dados do personagem carregados:', characterData);
                
                // Carregar skills detalhadas
                await loadCharacterSkills(characterData);
                
                renderCharacterProfile();
                
            } catch (error) {
                console.error('Erro ao carregar personagem:', error);
                document.getElementById('profileContainer').innerHTML = `
                    <div class="error">
                        ❌ Erro ao carregar perfil: ${error.message}
                        <br><br>
                        <a href="/cultural-characters/" class="nav-button">
                            ← Voltar para Lista
                        </a>
                    </div>
                `;
            }
        }
        
        // Função para carregar skills detalhadas do personagem
        async function loadCharacterSkills(character) {
            try {
                console.log('🔄 Carregando skills para:', character.name, 'Skills:', character.skills);
                
                if (!character.skills || character.skills.length === 0) {
                    console.log('⚠️ Personagem não possui skills');
                    character.detailedSkills = [];
                    return;
                }
                
                // Carregar todas as skills do banco de dados - sem cache
                const skillsUrl = `${API_BASE}/skills`;
                console.log('📡 Fazendo fetch para:', skillsUrl);
                
                const skillsResponse = await fetch(skillsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    cache: 'no-cache'
                });
                console.log('📡 Response status:', skillsResponse.status, skillsResponse.statusText);
                
                if (!skillsResponse.ok) {
                    throw new Error(`Erro ao carregar skills: ${skillsResponse.status}`);
                }
                
                const skillsData = await skillsResponse.json();
                console.log('📦 Skills data completa:', JSON.stringify(skillsData, null, 2));
                
                // Mapear IDs das skills do personagem para objetos detalhados
                character.detailedSkills = [];
                
                // Acessar skills do array corretamente
                const skillsArray = skillsData?.data?.skills || skillsData?.skills || [];
                console.log('🎯 Skills array extraído:', skillsArray.length, 'skills');
                console.log('🎯 Primeiro item do array:', skillsArray[0]);
                
                // Listar todos os IDs disponíveis na API
                const availableIds = skillsArray.map(s => s.id);
                console.log('🆔 IDs disponíveis na API:', availableIds);
                
                for (const skillRef of character.skills) {
                    const skillId = skillRef.skillId;
                    console.log(`🔍 Procurando skill: "${skillId}"`);
                    
                    // Procurar skill no array de skills
                    const skill = skillsArray.find(s => s.id === skillId);
                    
                    if (skill) {
                        console.log('✅ Skill encontrada:', skill.name);
                        character.detailedSkills.push({
                            ...skill,
                            source: skillRef.source
                        });
                    } else {
                        console.error(`❌ Skill não encontrada: "${skillId}"`);
                        console.log('📋 IDs disponíveis:', availableIds);
                        console.log('🔍 Testando match exato...');
                        
                        // Debug: testar match mais rigoroso
                        const exactMatch = skillsArray.find(s => {
                            console.log(`   Comparando "${s.id}" === "${skillId}": ${s.id === skillId}`);
                            return s.id === skillId;
                        });
                        
                        if (!exactMatch) {
                            // Adicionar placeholder para skill não encontrada
                            character.detailedSkills.push({
                                id: skillId,
                                name: `❌ Skill não encontrada (${skillId})`,
                                description: 'Esta skill não foi encontrada no banco de dados.',
                                damage: 0,
                                anima_cost: 0,
                                source: skillRef.source
                            });
                        }
                    }
                }
                
                console.log('🎉 Skills detalhadas carregadas:', character.detailedSkills.length, 'skills');
                
            } catch (error) {
                console.error('💥 Erro ao carregar skills detalhadas:', error);
                character.detailedSkills = [];
            }
        }
        
        // Função para converter nome do personagem em nome de arquivo
        function getStoryFilename(character) {
            if (!character || !character.name) return null;
            
            // Converter nome para formato de arquivo (minúsculo, espaços para underscore, remover caracteres especiais)
            return character.name
                .toLowerCase()
                .normalize('NFD') // Decomposição Unicode para separar acentos
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-z0-9\s]/g, '') // Remove caracteres especiais
                .trim()
                .replace(/\s+/g, '_'); // Substitui espaços por underscores
        }
        
        // Função para carregar história do arquivo markdown
        async function loadCharacterStory(character) {
            try {
                if (!character || !character.name) return null;
                
                const filename = getStoryFilename(character);
                console.log('Procurando arquivo de história para:', character.name, '-> filename:', filename);
                
                // Tentar diferentes possibilidades de nome e caminho do arquivo
                const possiblePaths = [
                    `/Personagens/historias/${filename}.md`,
                    `/Personagens/historias/${character.id}.md`,
                    `/personagens/historias/${filename}.md`,
                    `/character-stories/${filename}.md`
                ];
                
                for (const path of possiblePaths) {
                    try {
                        console.log('Tentando carregar:', path);
                        const response = await fetch(path);
                        if (response.ok) {
                            const storyText = await response.text();
                            console.log('História carregada com sucesso de:', path);
                            return parseMarkdownStory(storyText);
                        }
                    } catch (e) {
                        // Continua tentando o próximo caminho
                        console.log('Falhou ao carregar:', path);
                        continue;
                    }
                }
                
                console.log('Nenhum arquivo de história encontrado para:', character.name);
                return null; // Nenhum arquivo encontrado
                
            } catch (error) {
                console.warn('Erro ao carregar história:', error);
                return null;
            }
        }
        
        // Função para fazer parse básico do markdown
        function parseMarkdownStory(markdownText) {
            if (!markdownText) return null;
            
            // Dividir em linhas para processamento mais detalhado
            const lines = markdownText.split('\n');
            let html = '';
            let inCodeBlock = false;
            let inList = false;
            let currentParagraph = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                // Código em bloco
                if (trimmed.startsWith('```')) {
                    if (inCodeBlock) {
                        html += '</code></pre>\n';
                        inCodeBlock = false;
                    } else {
                        if (currentParagraph) {
                            html += processInlineMarkdown(currentParagraph) + '</p>\n';
                            currentParagraph = '';
                        }
                        html += '<pre><code>';
                        inCodeBlock = true;
                    }
                    continue;
                }
                
                if (inCodeBlock) {
                    html += line + '\n';
                    continue;
                }
                
                // Headers
                if (trimmed.match(/^#{1,4}\s/)) {
                    if (currentParagraph) {
                        html += processInlineMarkdown(currentParagraph) + '</p>\n';
                        currentParagraph = '';
                    }
                    
                    const headerLevel = trimmed.match(/^(#{1,4})/)[1].length;
                    const headerText = trimmed.replace(/^#{1,4}\s+/, '');
                    html += `<h${headerLevel}>${processInlineMarkdown(headerText)}</h${headerLevel}>\n`;
                    continue;
                }
                
                // Listas
                if (trimmed.match(/^[\-\*\+]\s/) || trimmed.match(/^\d+\.\s/)) {
                    if (currentParagraph) {
                        html += processInlineMarkdown(currentParagraph) + '</p>\n';
                        currentParagraph = '';
                    }
                    
                    if (!inList) {
                        const isOrdered = trimmed.match(/^\d+\.\s/);
                        html += isOrdered ? '<ol>\n' : '<ul>\n';
                        inList = isOrdered ? 'ol' : 'ul';
                    }
                    
                    const listText = trimmed.replace(/^[\-\*\+]\s/, '').replace(/^\d+\.\s/, '');
                    html += `<li>${processInlineMarkdown(listText)}</li>\n`;
                    continue;
                } else if (inList && trimmed === '') {
                    // Lista vazia indica fim da lista
                    html += `</${inList}>\n`;
                    inList = false;
                    continue;
                }
                
                // Linha horizontal
                if (trimmed.match(/^---+$/)) {
                    if (currentParagraph) {
                        html += processInlineMarkdown(currentParagraph) + '</p>\n';
                        currentParagraph = '';
                    }
                    html += '<hr>\n';
                    continue;
                }
                
                // Blockquote
                if (trimmed.startsWith('>')) {
                    if (currentParagraph) {
                        html += processInlineMarkdown(currentParagraph) + '</p>\n';
                        currentParagraph = '';
                    }
                    const quoteText = trimmed.replace(/^>\s*/, '');
                    html += `<blockquote><p>${processInlineMarkdown(quoteText)}</p></blockquote>\n`;
                    continue;
                }
                
                // Linha vazia
                if (trimmed === '') {
                    if (currentParagraph.trim()) {
                        html += '<p>' + processInlineMarkdown(currentParagraph) + '</p>\n';
                        currentParagraph = '';
                    }
                    if (inList) {
                        html += `</${inList}>\n`;
                        inList = false;
                    }
                    continue;
                }
                
                // Parágrafo normal
                if (currentParagraph) {
                    currentParagraph += ' ' + line;
                } else {
                    currentParagraph = line;
                }
            }
            
            // Fechar qualquer parágrafo pendente
            if (currentParagraph.trim()) {
                html += '<p>' + processInlineMarkdown(currentParagraph) + '</p>\n';
            }
            
            // Fechar lista pendente
            if (inList) {
                html += `</${inList}>\n`;
            }
            
            return html;
        }
        
        // Função para processar markdown inline
        function processInlineMarkdown(text) {
            return text
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Itálico
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code inline
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                // Emojis e símbolos especiais (preservar)
                .replace(/([🌍🎭📖⚔️🏛️🌿🎯📚🔮👁️⚙️🕊️🌟🛡️💰])/g, '$1');
        }
        
        // Função para renderizar o perfil do personagem
        function renderCharacterProfile() {
            if (!characterData) return;
            
            const character = characterData;
            
            document.getElementById('profileContainer').innerHTML = `
                <div class="profile-header">
                    <div class="profile-ornament">⟨ ❦ ⟩</div>
                    <h1 class="character-name">${character.name}</h1>
                    <div class="character-subtitle">${character.description || 'Embaixador Cultural'}</div>
                    <div class="character-tags">
                        <span class="tag">${character.classe}${character.subclasse ? ' / ' + character.subclasse : ''}</span>
                        <span class="tag culture">📍 ${character.cultura || 'Cultura Ancestral'}</span>
                    </div>
                </div>
                
                <div class="profile-content">
                    <div class="sidebar">
                        <div class="stats-panel">
                            <div class="stats-title">⚡ Atributos Culturais</div>
                            
                            <div class="stat-item">
                                <span class="stat-name">❤ Vida</span>
                                <span class="stat-value">${character.hp}/${character.maxHP || character.hp}</span>
                            </div>
                            
                            <div class="stat-item">
                                <span class="stat-name">✦ Ânima</span>
                                <span class="stat-value">${character.anima}</span>
                            </div>
                            
                            <div class="stat-item">
                                <span class="stat-name">⚔ Físico</span>
                                <span class="stat-value">${character.attack}</span>
                            </div>
                            
                            <div class="stat-item">
                                <span class="stat-name">🌟 Especial</span>
                                <span class="stat-value">${character.ataque_especial || character.specialAttack || 0}</span>
                            </div>
                            
                            <div class="stat-item">
                                <span class="stat-name">🛡 Defesa Física</span>
                                <span class="stat-value">${character.defense}</span>
                            </div>
                            
                            <div class="stat-item">
                                <span class="stat-name">🌟 Defesa Especial</span>
                                <span class="stat-value">${character.defesa_especial || character.specialDefense || 0}</span>
                            </div>
                            
                            <div class="stat-item">
                                <span class="stat-name">💫 Taxa Crítica</span>
                                <span class="stat-value">${character.critico}%</span>
                            </div>
                        </div>
                        
                        <div class="skills-panel">
                            <!-- Seção da Habilidade Ancestral -->
                            <div class="artifact-section">
                                <div class="artifact-title">📜 Habilidade Ancestral</div>
                                <div class="artifact-passive">
                                    <div class="passive-name">
                                        ✨ Poder Ancestral
                                    </div>
                                    <div class="passive-description">
                                        ${character.artefato || 'Artefato cultural ainda não foi descoberto...'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seção das Skills Ativas -->
                            <div class="cultural-elements-section">
                                <div id="skillsContainer">
                                    <div id="classSkillsSection"></div>
                                    <div id="subclassSkillsSection"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="main-content">
                        <div class="content-section">
                            <h2 class="section-title">📖 História Cultural</h2>
                            <div class="section-content" id="characterStory">
                                <p>🔄 Carregando história ancestral...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Carregar história do arquivo markdown
            loadCharacterStory(character).then(storyHtml => {
                const storyContainer = document.getElementById('characterStory');
                if (storyHtml) {
                    storyContainer.innerHTML = `<div class="markdown-content">${storyHtml}</div>`;
                } else {
                    storyContainer.innerHTML = `
                        <p><em>História detalhada em desenvolvimento. Este personagem representa a rica tradição cultural de ${character.cultura || 'sua civilização ancestral'}, carregando consigo séculos de sabedoria e tradições.</em></p>
                        <p>Como ${character.classe}, ele domina as artes e conhecimentos específicos de sua cultura, sendo um verdadeiro embaixador de sua civilização.</p>
                    `;
                }
            });
            
            // Separar skills de classe e subclasse
            const classSkillsContainer = document.getElementById('classSkillsSection');
            const subclassSkillsContainer = document.getElementById('subclassSkillsSection');
            
            if (character.detailedSkills && character.detailedSkills.length > 0) {
                const classSkills = character.detailedSkills.filter(skill => 
                    skill.source === 'chan_martial_arts' || skill.source === 'legacy' || skill.source === 'skills_module' ||
                    !skill.source || skill.source.indexOf('naturalista') === -1
                );
                const subclassSkills = character.detailedSkills.filter(skill => 
                    skill.source && skill.source.indexOf('naturalista') !== -1
                );
                
                // Habilidades de Classe
                if (classSkills.length > 0) {
                    let classHtml = '<h4 style="font-family: \'Cinzel\', serif; color: #722F37; margin: 15px 0 10px 0; font-size: 1.1em; font-weight: 600; text-align: center;">⚔️ Artes Combativas</h4>';
                    classSkills.forEach(skill => {
                        classHtml += `
                            <div class="skill-item">
                                <div class="skill-header">
                                    <span class="skill-name">${skill.name || 'Habilidade Desconhecida'}</span>
                                    ${skill.damage ? `<span class="skill-damage">${skill.damage > 0 ? skill.damage : 'Cura ' + Math.abs(skill.damage)}</span>` : ''}
                                </div>
                                ${skill.description ? `<div class="skill-description">${skill.description}</div>` : ''}
                                ${skill.anima_cost ? `<div class="skill-cost" style="font-size: 0.8em; color: #355E3B; margin-top: 5px;">💫 Custo: ${skill.anima_cost} Ânima</div>` : ''}
                            </div>
                        `;
                    });
                    classSkillsContainer.innerHTML = classHtml;
                }
                
                // Habilidades de Sub-classe
                if (subclassSkills.length > 0) {
                    let subclassHtml = '<h4 style="font-family: \'Cinzel\', serif; color: #355E3B; margin: 20px 0 10px 0; font-size: 1.1em; font-weight: 600; text-align: center;">🌿 Habilidades de Sub-classe</h4>';
                    subclassSkills.forEach(skill => {
                        subclassHtml += `
                            <div class="skill-item" style="background: rgba(53, 94, 59, 0.15);">
                                <div class="skill-header">
                                    <span class="skill-name">${skill.name || 'Habilidade Desconhecida'}</span>
                                    ${skill.damage ? `<span class="skill-damage">${skill.damage > 0 ? skill.damage : 'Cura ' + Math.abs(skill.damage)}</span>` : ''}
                                </div>
                                ${skill.description ? `<div class="skill-description">${skill.description}</div>` : ''}
                                ${skill.anima_cost ? `<div class="skill-cost" style="font-size: 0.8em; color: #355E3B; margin-top: 5px;">💫 Custo: ${skill.anima_cost} Ânima</div>` : ''}
                            </div>
                        `;
                    });
                    subclassSkillsContainer.innerHTML = subclassHtml;
                }
                
                // Se não há skills de classe mas há detailedSkills, mostrar todas
                if (classSkills.length === 0 && subclassSkills.length === 0 && character.detailedSkills.length > 0) {
                    let allSkillsHtml = '<h4 style="font-family: \'Cinzel\', serif; color: #722F37; margin: 15px 0 10px 0; font-size: 1.1em; font-weight: 600; text-align: center;">⚔️ Artes Combativas</h4>';
                    character.detailedSkills.forEach(skill => {
                        allSkillsHtml += `
                            <div class="skill-item">
                                <div class="skill-header">
                                    <span class="skill-name">${skill.name || 'Habilidade Desconhecida'}</span>
                                    ${skill.damage ? `<span class="skill-damage">${skill.damage > 0 ? skill.damage : 'Cura ' + Math.abs(skill.damage)}</span>` : ''}
                                </div>
                                ${skill.description ? `<div class="skill-description">${skill.description}</div>` : ''}
                                ${skill.anima_cost ? `<div class="skill-cost" style="font-size: 0.8em; color: #355E3B; margin-top: 5px;">💫 Custo: ${skill.anima_cost} Ânima</div>` : ''}
                            </div>
                        `;
                    });
                    classSkillsContainer.innerHTML = allSkillsHtml;
                }
            } else {
                classSkillsContainer.innerHTML = '<div class="no-skills">🔄 Carregando artes combativas...</div>';
            }
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            const characterId = getCharacterIdFromURL();
            
            if (!characterId) {
                document.getElementById('profileContainer').innerHTML = `
                    <div class="error">
                        ⚠️ ID do personagem não especificado na URL
                        <br><br>
                        <a href="/cultural-characters/" class="nav-button">
                            ← Voltar para Lista
                        </a>
                    </div>
                `;
                return;
            }
            
            loadCharacter(characterId);
        });
    </script>
</body>
</html>