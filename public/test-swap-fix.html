<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Corre√ß√£o do Sistema de Trocas</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîÑ Teste de Corre√ß√£o do Sistema de Trocas</h1>
    
    <div class="test-container info">
        <h3>üéØ Objetivo</h3>
        <p>Testar se o sistema de trocas de personagens funciona corretamente ap√≥s a corre√ß√£o no backend.</p>
        <p><strong>Corre√ß√£o aplicada:</strong> Verifica√ß√£o de personagens dispon√≠veis baseada em HP, n√£o em status.</p>
    </div>
    
    <div class="test-container">
        <h3>‚öôÔ∏è Controles de Teste</h3>
        <button onclick="initializeTest()">1Ô∏è‚É£ Inicializar Sistema</button>
        <button onclick="startBattle()">2Ô∏è‚É£ Iniciar Batalha 3v3</button>
        <button onclick="testSwap()">3Ô∏è‚É£ Testar Troca</button>
        <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
    </div>
    
    <div class="test-container">
        <h3>üìä Status da Batalha</h3>
        <div id="battleStatus">Sistema n√£o inicializado</div>
    </div>
    
    <div class="test-container">
        <h3>üìú Log de Testes</h3>
        <div id="testLog" class="log">Aguardando testes...</div>
    </div>
    
    <script src="secure-battle-client.js"></script>
    <script>
        let secureBattleClient = null;
        let testCharacters = [];
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üìù';
            logElement.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateBattleStatus(status) {
            document.getElementById('battleStatus').textContent = status;
        }
        
        async function initializeTest() {
            try {
                log('Inicializando cliente de batalha segura...');
                secureBattleClient = new SecureBattleClient();
                
                // Carregar personagens dispon√≠veis
                log('Carregando personagens do servidor...');
                const response = await fetch('/api/characters');
                const data = await response.json();
                testCharacters = Object.values(data.characters);
                
                log(`‚úÖ ${testCharacters.length} personagens carregados`);
                log('Personagens dispon√≠veis:');
                testCharacters.slice(0, 6).forEach((char, index) => {
                    log(`  ${index}: ${char.name} (ID: ${char.id})`);
                });
                
                updateBattleStatus('Sistema inicializado - Pronto para batalha');
                
            } catch (error) {
                log(`Erro na inicializa√ß√£o: ${error.message}`, 'error');
                updateBattleStatus('Erro na inicializa√ß√£o');
            }
        }
        
        async function startBattle() {
            if (!secureBattleClient) {
                log('Sistema n√£o inicializado! Execute o passo 1 primeiro.', 'error');
                return;
            }
            
            try {
                // Selecionar 6 personagens para a batalha (3 vs 3)
                const playerTeam = testCharacters.slice(0, 3).map(char => ({
                    id: char.id,
                    name: char.name
                }));
                
                const enemyTeam = testCharacters.slice(3, 6).map(char => ({
                    id: char.id,
                    name: char.name
                }));
                
                log('Iniciando batalha 3v3...');
                log(`Equipe Jogador: ${playerTeam.map(c => c.name).join(', ')}`);
                log(`Equipe Inimiga: ${enemyTeam.map(c => c.name).join(', ')}`);
                
                const battleResult = await secureBattleClient.startSecureBattle({
                    playerTeam,
                    enemyTeam,
                    battleType: '3v3'
                });
                
                if (battleResult.success) {
                    log('‚úÖ Batalha iniciada com sucesso!', 'success');
                    log(`Battle ID: ${battleResult.battleId}`);
                    
                    const battleState = secureBattleClient.battleState;
                    log(`Personagem ativo: ${battleState.playerTeam.characters[battleState.playerTeam.activeIndex].name}`);
                    log(`Trocas dispon√≠veis: ${battleState.playerTeam.maxSwaps - battleState.playerTeam.swapsUsed}`);
                    
                    updateBattleStatus(`Batalha ativa - ID: ${battleResult.battleId}`);
                } else {
                    log(`Erro ao iniciar batalha: ${battleResult.error}`, 'error');
                    updateBattleStatus('Erro ao iniciar batalha');
                }
                
            } catch (error) {
                log(`Erro na inicializa√ß√£o da batalha: ${error.message}`, 'error');
                updateBattleStatus('Erro na batalha');
            }
        }
        
        async function testSwap() {
            if (!secureBattleClient || !secureBattleClient.isBattleActive()) {
                log('Batalha n√£o est√° ativa! Execute os passos 1 e 2 primeiro.', 'error');
                return;
            }
            
            try {
                const battleState = secureBattleClient.battleState;
                const currentActiveIndex = battleState.playerTeam.activeIndex;
                
                // Encontrar um personagem na reserva para trocar
                let targetIndex = -1;
                for (let i = 0; i < battleState.playerTeam.characters.length; i++) {
                    if (i !== currentActiveIndex && battleState.playerTeam.characters[i].currentHP > 0) {
                        targetIndex = i;
                        break;
                    }
                }
                
                if (targetIndex === -1) {
                    log('Nenhum personagem dispon√≠vel para troca', 'error');
                    return;
                }
                
                const currentChar = battleState.playerTeam.characters[currentActiveIndex];
                const targetChar = battleState.playerTeam.characters[targetIndex];
                
                log(`üîÑ Tentando trocar: ${currentChar.name} (${currentActiveIndex}) ‚Üí ${targetChar.name} (${targetIndex})`);
                log(`Trocas usadas: ${battleState.playerTeam.swapsUsed}/${battleState.playerTeam.maxSwaps}`);
                
                const swapResult = await secureBattleClient.executeSecureSwap(currentActiveIndex, targetIndex);
                
                if (swapResult.success) {
                    log('‚úÖ Troca executada com sucesso!', 'success');
                    log(`Novo personagem ativo: ${swapResult.newActiveCharacter.name}`);
                    log(`Trocas restantes: ${swapResult.swapsRemaining}`);
                    
                    updateBattleStatus(`Troca realizada - Ativo: ${swapResult.newActiveCharacter.name}`);
                } else {
                    log(`‚ùå Falha na troca: ${swapResult.error || 'Erro desconhecido'}`, 'error');
                    updateBattleStatus('Falha na troca');
                }
                
            } catch (error) {
                log(`Erro durante a troca: ${error.message}`, 'error');
                updateBattleStatus('Erro durante troca');
            }
        }
        
        function clearLog() {
            document.getElementById('testLog').textContent = 'Log limpo - Aguardando novos testes...\n';
        }
        
        // Inicializar automaticamente ao carregar a p√°gina
        window.addEventListener('load', () => {
            log('üöÄ Sistema de teste carregado');
            log('Execute os testes na ordem: 1Ô∏è‚É£ ‚Üí 2Ô∏è‚É£ ‚Üí 3Ô∏è‚É£');
        });
    </script>
</body>
</html>