# Sistema de Efeitos - RPGStack v4.5

## Vis√£o Geral

O Sistema de Efeitos do RPGStack utiliza uma arquitetura de **coeficientes din√¢micos** que permite criar habilidades complexas e variadas sem duplica√ß√£o de c√≥digo. Cada efeito √© gen√©rico e seus valores espec√≠ficos s√£o definidos por coeficientes √∫nicos para cada skill.

## Arquitetura do Sistema

### Estrutura de uma Skill

```json
{
  "id": "SHIWX001LT",
  "name": "üëÅÔ∏è Qian Shou Qian Yan - Mil M√£os, Mil Olhos",
  "type": "combat",
  "damage": 15,
  "anima_cost": 25,
  "cooldown": 3,
  "duration": 2,
  
  // Array de efeitos gen√©ricos
  "effects": [
    "multi_hit",
    "critical_boost", 
    "critical_immunity",
    "physical_reduction"
  ],
  
  // Coeficientes espec√≠ficos para multi-hit
  "multi_hit": {
    "hits": 5,
    "damage_per_hit": 15,
    "independent_crits": true,
    "total_damage_potential": 75
  },
  
  // Coeficientes espec√≠ficos para buffs
  "buffs": {
    "critical_rate": {
      "bonus": 20,
      "duration": 2,
      "description": "Aumenta chance cr√≠tica em 20%"
    },
    "critical_immunity": {
      "immunity": true,
      "duration": 2,
      "description": "Imune a danos cr√≠ticos por 2 turnos"
    },
    "physical_reduction": {
      "reduction_percentage": 80,
      "duration": 2,
      "description": "Ataque f√≠sico reduzido em 80%"
    }
  }
}
```

## Tipos de Efeitos

### 1. Multi-Hit Effects

**Efeito:** `"multi_hit"`

**Configura√ß√£o:**
```json
"multi_hit": {
  "hits": 7,                    // N√∫mero de ataques
  "damage_per_hit": 20,         // Dano por ataque individual
  "independent_crits": true,    // Cada hit pode ser cr√≠tico independentemente
  "total_damage_potential": 140 // Dano m√°ximo poss√≠vel (calculado automaticamente)
}
```

**Como funciona:**
- Skill executa m√∫ltiplos ataques em sequ√™ncia
- Cada hit pode ter chance cr√≠tica independente se `independent_crits: true`
- Dano total = `hits √ó damage_per_hit` (+ b√¥nus cr√≠ticos)

### 2. Critical Boost Effects

**Efeito:** `"critical_boost"`

**Configura√ß√£o:**
```json
"buffs": {
  "critical_rate": {
    "bonus": 25,                // +25% de chance cr√≠tica
    "duration": 3,              // Por 3 turnos
    "description": "Aumenta chance cr√≠tica em 25%"
  }
}
```

### 3. Physical Reduction Effects

**Efeito:** `"physical_reduction"`

**Configura√ß√£o:**
```json
"buffs": {
  "physical_reduction": {
    "reduction_percentage": 60,  // Reduz ataque f√≠sico em 60%
    "duration": 2,               // Por 2 turnos
    "description": "Ataque f√≠sico reduzido em 60%"
  }
}
```

### 4. Immunity Effects

**Efeito:** `"critical_immunity"`

**Configura√ß√£o:**
```json
"buffs": {
  "critical_immunity": {
    "immunity": true,
    "duration": 3,
    "description": "Imune a danos cr√≠ticos por 3 turnos"
  }
}
```

### 5. Healing Effects

**Efeito:** `"healing"`

**Configura√ß√£o v4.9:**
```json
{
  "damage": 120,  // Quantidade base de cura
  "effects": ["healing"],
  "buffs": {
    "healing": {
      "heal_amount": 120,           // Quantidade exata de cura
      "target_type": "area",        // Tipo: "single", "area", "self"
      "target_scope": "allies",     // Escopo: "allies", "self", "enemies"
      "description": "Cura 120 HP em todos os aliados"
    }
  }
}
```

**Op√ß√µes de Alvo v4.9:**
- **target_type:**
  - `"self"` - Apenas o usu√°rio
  - `"single"` - Um aliado espec√≠fico
  - `"area"` - M√∫ltiplos alvos
- **target_scope:**
  - `"self"` - Pr√≥prio usu√°rio
  - `"allies"` - Aliados apenas
  - `"enemies"` - Inimigos apenas

### 6. Purification Effects

**Efeito:** `"purification"`

**Configura√ß√£o v4.9:**
```json
{
  "effects": ["purification"],
  "buffs": {
    "purification": {
      "dispel_type": "all",          // Tipo: "all", "debuffs", "buffs", "specific"
      "target_type": "area",         // Tipo: "single", "area", "self"
      "target_scope": "allies",      // Escopo: "allies", "self", "enemies"
      "description": "Remove todos os debuffs de todos os aliados"
    }
  }
}
```

**Op√ß√µes de Purifica√ß√£o v4.9:**
- **dispel_type:**
  - `"all"` - Remove todos os efeitos
  - `"debuffs"` - Apenas efeitos negativos
  - `"buffs"` - Apenas efeitos positivos
  - `"specific"` - Efeito espec√≠fico (requer campo adicional)

### 7. Status Effects

**Efeitos dispon√≠veis:**
- `"intangibility"` - Imune a ataques f√≠sicos
- `"spiritual_stun"` - Atordoamento espiritual  
- `"purification"` - Remove efeitos negativos
- `"affinity_immunity"` - Imunidade a afinidades espec√≠ficas

## Processamento dos Efeitos

### Fluxo de Execu√ß√£o

1. **Carregamento da Skill** - Sistema carrega skill do banco de dados
2. **Valida√ß√£o** - Verifica custos de √Çnima e cooldown
3. **Processamento de Efeitos** - `processSkillEffects()` analisa cada efeito
4. **C√°lculo de Dano** - Combina dano base + dano dos efeitos
5. **Aplica√ß√£o** - Aplica dano, cura, buffs e status effects
6. **Log** - Registra todos os resultados no battle log

### M√©todo `processSkillEffects()`

```javascript
const effectsResult = await battleMechanics.processSkillEffects(skill, attacker, target, battleId);

// Retorna:
{
  damage: 82,           // Dano adicional dos efeitos
  healing: 0,           // Cura aplicada
  statusEffects: [],    // Status effects para aplicar
  buffs: [              // Buffs para aplicar
    {
      type: 'critical_rate',
      target: 'attacker',
      bonus: 20,
      duration: 2
    }
  ],
  specialActions: [     // A√ß√µes especiais executadas
    "Multi-Hit: 5 ataques por 15 cada"
  ]
}
```

## Exemplo Pr√°tico

### Criando uma Nova Skill com Multi-Hit de 8 Ataques

**Antes (sistema antigo - INCORRETO):**
```json
"effects": ["multi_hit_8x"]  // ‚ùå Precisaria criar novo efeito hardcoded
```

**Depois (sistema atual - CORRETO):**
```json
{
  "effects": ["multi_hit"],
  "multi_hit": {
    "hits": 8,
    "damage_per_hit": 12,
    "independent_crits": true
  }
}
```

### Criando Critical Boost Vari√°vel

**Para +15% cr√≠tico por 4 turnos:**
```json
{
  "effects": ["critical_boost"],
  "buffs": {
    "critical_rate": {
      "bonus": 15,
      "duration": 4,
      "description": "Aumenta chance cr√≠tica em 15%"
    }
  }
}
```

**Para +30% cr√≠tico por 1 turno:**
```json
{
  "effects": ["critical_boost"],
  "buffs": {
    "critical_rate": {
      "bonus": 30,
      "duration": 1,
      "description": "Aumenta chance cr√≠tica em 30%"
    }
  }
}
```

## Vantagens do Sistema

### ‚úÖ Flexibilidade Total
- **Multi-hit**: Qualquer quantidade de hits (1, 3, 5, 7, 10, etc.)
- **Critical boost**: Qualquer porcentagem (5%, 15%, 25%, 50%, etc.)
- **Dura√ß√£o**: Qualquer n√∫mero de turnos

### ‚úÖ Zero Duplica√ß√£o de C√≥digo
- Um efeito `"multi_hit"` serve para todas as varia√ß√µes
- Um efeito `"critical_boost"` serve para todos os b√¥nus cr√≠ticos
- N√£o precisa criar `"multi_hit_3x"`, `"multi_hit_7x"`, etc.

### ‚úÖ Facilidade de Balanceamento
- Alterar coeficientes √© simples e direto
- Cada skill pode ter valores √∫nicos
- F√°cil de experimentar e ajustar

### ‚úÖ Extensibilidade
- Novos coeficientes podem ser adicionados facilmente
- Sistema preparado para futuros efeitos
- Interface de edi√ß√£o j√° suporta coeficientes din√¢micos

## Interface de Edi√ß√£o v4.9

O sistema inclui uma interface web para edi√ß√£o de skills em `/public/skills/skills.html` que permite:

- **Editar coeficientes em tempo real**
- **Visualizar efeitos aplicados**
- **Testar diferentes configura√ß√µes**
- **Salvar altera√ß√µes no banco de dados**
- **Preserva√ß√£o autom√°tica de dados** durante salvamento
- **‚ú® Novo v4.9:** Sistema de exclus√£o com modal de confirma√ß√£o
- **‚ú® Novo v4.9:** Carregamento din√¢mico via API `/api/skills`
- **‚ú® Novo v4.9:** Sincroniza√ß√£o autom√°tica com perfis de personagem

### Coeficientes Edit√°veis na Interface:

#### üéØ Multi-Hit
- **N√∫mero de Hits**: Controle deslizante (1-20)
- **Dano por Hit**: Input num√©rico
- **Cr√≠ticos Independentes**: Toggle Sim/N√£o
- **C√°lculo autom√°tico** do total damage potential

#### ‚ö° Aumento Cr√≠tico
- **B√¥nus (%)**: Input num√©rico (0-200%)
- **Dura√ß√£o (turnos)**: Input num√©rico (0-10)
- **Descri√ß√£o**: Gerada automaticamente

#### üõ°Ô∏è Imunidade Cr√≠tica
- **Dura√ß√£o (turnos)**: Input num√©rico (0-10)
- **Imunidade**: Toggle Ativa/Inativa
- **Status visual**: Indicador de ativa√ß√£o

#### ‚¨áÔ∏è Redu√ß√£o F√≠sica
- **Redu√ß√£o (%)**: Input num√©rico (0-100%)
- **Dura√ß√£o (turnos)**: Input num√©rico (0-10)
- **C√°lculo visual**: Mostra divisor equivalente

#### ‚ú® Novo v4.9: üíö Cura
- **Quantidade de Cura**: Input num√©rico (0-999)
- **Tipo de Alvo**: Select (self/single/area)
- **Escopo do Alvo**: Select (self/allies/enemies)
- **Descri√ß√£o**: Gerada automaticamente

#### ‚ú® Novo v4.9: üßπ Purifica√ß√£o
- **Tipo de Dispel**: Select (all/debuffs/buffs/specific)
- **Tipo de Alvo**: Select (self/single/area)
- **Escopo do Alvo**: Select (self/allies/enemies)
- **Descri√ß√£o**: Gerada automaticamente

### Arquitetura da Interface

A interface utiliza **mapeamento din√¢mico** entre elementos HTML e estrutura JSON:

```javascript
// Coleta autom√°tica de coeficientes
function collectEffectCoefficients() {
  const coefficients = {};
  
  // Multi-hit: inputs com prefixo 'multiHit_'
  if (name.startsWith('multiHit_')) {
    coefficients.multi_hit = {
      hits: parseInt(value),
      damage_per_hit: parseInt(value),
      independent_crits: value === 'true'
    };
  }
  
  // Buffs: inputs com padr√£o 'buff_{nome}_{propriedade}'
  else if (name.startsWith('buff_')) {
    const parts = name.split('_');
    const buffName = parts.slice(1, -1).join('_');
    const property = parts[parts.length - 1];
    
    if (!coefficients.buffs[buffName]) coefficients.buffs[buffName] = {};
    
    // ‚ú® v4.9: Mapeamento expandido para healing/purification
    if (property === 'healAmount') coefficients.buffs[buffName].heal_amount = parseInt(value);
    else if (property === 'targetType') coefficients.buffs[buffName].target_type = value;
    else if (property === 'targetScope') coefficients.buffs[buffName].target_scope = value;
    else if (property === 'dispelType') coefficients.buffs[buffName].dispel_type = value;
    else coefficients.buffs[buffName][property] = isNaN(value) ? value : parseInt(value);
  }
}
```

### Preserva√ß√£o de Dados

**Sistema de preserva√ß√£o autom√°tica** garante que coeficientes n√£o sejam perdidos:

```javascript
// SkillService.js - Atualiza√ß√£o segura
const updatedSkill = new Skill({
  // ... outros campos
  multi_hit: sanitizedData.multi_hit ?? existingSkill.multi_hit,
  buffs: sanitizedData.buffs ?? existingSkill.buffs,
  cultural_authenticity: sanitizedData.cultural_authenticity ?? existingSkill.cultural_authenticity
});
```

**Frontend - Preserva√ß√£o condicional:**
```javascript
// Apenas sobrescrever coeficientes se foram coletados novos valores
if (coefficients.multi_hit) {
  updatedSkill.multi_hit = coefficients.multi_hit;
}
if (coefficients.buffs && Object.keys(coefficients.buffs).length > 0) {
  updatedSkill.buffs = coefficients.buffs;
}
```

## Problemas Resolvidos e Solu√ß√µes v4.9

### üîß Problema: Perda de Coeficientes Durante Salvamento

**Sintoma:** Ap√≥s salvar uma skill no modal de edi√ß√£o, os coeficientes `multi_hit` e `buffs` eram perdidos, voltando para `null`.

**Causa Raiz:** 
1. **SkillService**: N√£o tratava campos `multi_hit`, `buffs`, `cultural_authenticity` durante updates
2. **Frontend**: Desalinhamento entre chaves esperadas e geradas na coleta de coeficientes

**Solu√ß√£o Implementada:**

#### Backend (SkillService.js):
```javascript
// Adicionado tratamento dos campos cr√≠ticos
async _validateAndSanitizeUpdateData(updateData, existingSkill) {
  // ... outros campos
  
  // SISTEMA DE COEFICIENTES DIN√ÇMICOS - Preservar multi_hit e buffs
  if (updateData.multi_hit !== undefined) {
    sanitized.multi_hit = updateData.multi_hit;
  }
  if (updateData.buffs !== undefined) {
    sanitized.buffs = updateData.buffs;
  }
  if (updateData.cultural_authenticity !== undefined) {
    sanitized.cultural_authenticity = updateData.cultural_authenticity;
  }
}
```

#### Frontend (skills.js):
```javascript
// Processamento corrigido para nomes compostos de buffs
else if (name.startsWith('buff_')) {
  const parts = name.split('_');
  
  // Reconstruir o nome completo do buff (critical_rate, critical_immunity, etc.)
  const buffName = parts.slice(1, -1).join('_'); 
  const property = parts[parts.length - 1];
  
  if (!coefficients.buffs[buffName]) coefficients.buffs[buffName] = {};
  coefficients.buffs[buffName][property] = value;
}
```

### üîß Problema: Mapeamento Incorreto de Chaves de Buffs

**Sintoma:** Interface mostrava coeficientes na primeira visualiza√ß√£o, mas n√£o ap√≥s salvamento.

**Causa:** Fun√ß√£o `collectEffectCoefficients()` n√£o processava corretamente nomes como `critical_rate`, truncando para `critical`.

**Solu√ß√£o:** Algoritmo robusto de parsing que preserva underscores em nomes de buffs.

### üîß Problema: Inconsist√™ncia de Dados

**Sintoma:** Dados alternavam entre formatos ap√≥s cada opera√ß√£o de salvamento.

**Solu√ß√£o:** 
1. **Valida√ß√£o rigorosa** de formatos esperados
2. **Restaura√ß√£o autom√°tica** de dados corrompidos
3. **Debug logging** extensivo para rastreamento

### üîß v4.9: Problema de API Retornando Buffs: null

**Sintoma:** Modal de edi√ß√£o mostrava "Esta skill n√£o possui coeficientes edit√°veis" mesmo para skills com dados de `buffs`.

**Causa Raiz:** 
1. **Skill.js**: Faltavam getters para `buffs`, `multi_hit`, `battlefield_effects`, `affinity`
2. **JsonSkillRepository.js**: N√£o passava explicitamente os campos din√¢micos para o construtor da entidade

**Solu√ß√£o Implementada:**

#### Domain Entity (Skill.js):
```javascript
// Adicionados getters essenciais para API
get multi_hit() { return this._multi_hit; }
get buffs() { return this._buffs; }
get battlefield_effects() { return this._battlefield_effects; }
get affinity() { return this._affinity; }
```

#### Repository (JsonSkillRepository.js):
```javascript
// Carregamento expl√≠cito de campos din√¢micos
const skill = new Skill({
  ...skillData,
  multi_hit: skillData.multi_hit || null,
  buffs: skillData.buffs || null,
  battlefield_effects: skillData.battlefield_effects || null,
  affinity: skillData.affinity || '',
  cultural_authenticity: skillData.cultural_authenticity || ''
});
```

### üîß v4.9: Funcionalidade de Delete Ausente

**Sintoma:** Bot√£o de deletar skills desapareceu ap√≥s implementa√ß√£o do sistema de afinidades.

**Causa:** Fun√ß√£o `createDeleteModal()` estava sendo chamada mas n√£o existia no c√≥digo.

**Solu√ß√£o Implementada:**

#### Frontend (skills.js):
```javascript
function createDeleteModal() {
  let modal = document.getElementById('deleteModal');
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'deleteModal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content">
        <h2>üóëÔ∏è Confirmar Exclus√£o</h2>
        <p>Tem certeza que deseja excluir esta skill permanentemente?</p>
        <div class="modal-buttons">
          <button onclick="executeSkillDeletion()" class="delete-btn">üóëÔ∏è Excluir</button>
          <button onclick="closeDeleteModal()" class="cancel-btn">‚ùå Cancelar</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  return modal;
}
```

### ‚úÖ Status Atual v4.9: Sistema Totalmente Funcional

- ‚úÖ **Preserva√ß√£o de dados** durante salvamento
- ‚úÖ **Mapeamento correto** de coeficientes  
- ‚úÖ **Interface responsiva** com feedback em tempo real
- ‚úÖ **Valida√ß√£o robusta** de entrada
- ‚úÖ **Debug logging** completo
- ‚úÖ **‚ú® v4.9:** API retorna buffs corretamente via getters
- ‚úÖ **‚ú® v4.9:** Sistema de delete funcional com modal de confirma√ß√£o
- ‚úÖ **‚ú® v4.9:** Coeficientes de cura e purifica√ß√£o implementados
- ‚úÖ **‚ú® v4.9:** Sincroniza√ß√£o autom√°tica entre skills e perfis de personagem

## Migra√ß√£o de Skills Antigas

Para migrar skills do sistema antigo, use o script:

```bash
node migrate-effects-to-coefficients.js
```

O script automaticamente:
1. **Faz backup** dos dados originais
2. **Converte efeitos hardcoded** para gen√©ricos
3. **Cria coeficientes apropriados** baseados nos valores existentes
4. **Gera log detalhado** da migra√ß√£o

## Teste do Sistema

Execute os testes para verificar o funcionamento:

```bash
node test-effects-migration.js
```

Os testes verificam:
- ‚úÖ Carregamento correto de skills
- ‚úÖ Processamento de efeitos
- ‚úÖ C√°lculo de multi-hit
- ‚úÖ Sistema de fallback
- ‚úÖ Integridade do banco de dados

## Considera√ß√µes de Performance

### Otimiza√ß√µes Implementadas:
- **Cache de skills** para evitar leituras repetidas do disco
- **Processamento ass√≠ncrono** para n√£o bloquear o sistema
- **Valida√ß√£o eficiente** dos coeficientes
- **Log estruturado** para debugging

### Monitoramento:
- Sistema registra tempo de processamento
- Logs detalhados de aplica√ß√£o de efeitos
- M√©tricas de performance no battle log

## Pr√≥ximos Passos

### Funcionalidades Planejadas:
1. **Efeitos condicionais** baseados no HP atual
2. **Combos de efeitos** que se potencializam mutuamente  
3. **Efeitos temporais** que mudam ao longo do combate
4. **Sistema de resist√™ncias** espec√≠ficas por personagem
5. **Efeitos de √°rea** que afetam m√∫ltiplos alvos

### Melhorias na Interface:
1. **Preview em tempo real** dos efeitos
2. **Calculadora de dano** integrada
3. **Biblioteca de templates** de efeitos comuns
4. **Sistema de versionamento** para skills

## Debugging e Monitoramento

### Logs de Debug Dispon√≠veis:

```javascript
// Frontend - Console do navegador
console.log('üîç DEBUG: Skills por classe:', skillsByClass);
console.log('üì¶ DEBUG: Coeficientes coletados:', coefficients);
console.log('üöÄ DEBUG: Payload sendo enviado:', updatedSkill);

// Backend - Console do servidor
this.logger.info('Updating skill', { 
  id: id.toString(), 
  updates: Object.keys(updateData) 
});
```

### Comandos de Teste:

```bash
# Testar API de Skills
node debug-skills-api.js

# Verificar integridade dos dados
node migrate-effects-to-coefficients.js --dry-run

# Backup de seguran√ßa
cp data/skills.json data/skills_backup_$(date +%Y%m%d_%H%M%S).json
```

### Estrutura de Arquivos:

```
rpgstack/
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ skills.json                              # Banco principal
‚îÇ   ‚îú‚îÄ‚îÄ skills_backup_before_coefficients_migration.json  # Backup original
‚îÇ   ‚îî‚îÄ‚îÄ migration_log_effects_to_coefficients.json        # Log de migra√ß√£o
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ application/services/SkillService.js     # Backend service
‚îÇ   ‚îî‚îÄ‚îÄ domain/entities/Skill.js                 # Entidade de dom√≠nio
‚îî‚îÄ‚îÄ public/
    ‚îî‚îÄ‚îÄ skills/
        ‚îú‚îÄ‚îÄ skills.html                          # Interface web
        ‚îú‚îÄ‚îÄ skills.js                            # L√≥gica frontend
        ‚îî‚îÄ‚îÄ skills.css                           # Estilos
```

---

**Documenta√ß√£o atualizada em:** 06/09/2025 - 20:30 BRT  
**Vers√£o do sistema:** RPGStack v4.9 - Sistema de Coeficientes Din√¢micos Expandido  
**Status:** ‚úÖ Sistema totalmente funcional e testado  
**Recursos v4.9:**  
- ‚úÖ **Coeficientes de Cura e Purifica√ß√£o**: Target selection completo  
- ‚úÖ **Fix de API**: Getters em Skill.js + Repository corrigido  
- ‚úÖ **Sistema de Delete**: Modal de confirma√ß√£o funcional  
- ‚úÖ **Sincroniza√ß√£o**: Skills ‚Üî Character profiles din√¢mica  
- ‚úÖ **Interface Expandida**: Controles para todos os novos coeficientes  
**Autor:** Sistema de Efeitos com Coeficientes Din√¢micos  
**√öltima atualiza√ß√£o:** v4.9 - Healing/Purification + Delete System