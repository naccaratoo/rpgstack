#!/usr/bin/env node

/**
 * RPGStack Skills Migration Script
 * 
 * This script migrates character skills from frontend JavaScript files 
 * to the backend Skills API system, ensuring proper data structure 
 * and cultural authenticity preservation.
 * 
 * Usage: node migrate-skills.js
 */

import fetch from 'node-fetch'; // You may need to install: npm install node-fetch
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// API Configuration
const API_BASE_URL = 'http://localhost:3002/api';
const SKILLS_ENDPOINT = `${API_BASE_URL}/skills`;

// Migration configuration
const CONFIG = {
  batchSize: 10,
  retryAttempts: 3,
  retryDelay: 1000,
  validateData: true,
  backupExisting: true
};

/**
 * Skill Type Mapping from Frontend to Backend
 * Maps custom frontend types to valid backend types
 */
const SKILL_TYPE_MAPPING = {
  // Frontend types -> Backend valid types
  "command_magic": "combat",
  "defensive_formation": "buff", 
  "weapon_mastery": "combat",
  "elemental_cycle": "magic",
  "balance_harmony": "utility",
  "dragon_summon": "combat",
  "weapon_craft": "combat",
  "ancestral_summon": "combat",
  "defensive_craft": "buff",
  "prediction": "magic",
  "divine_storm": "magic",
  "divine_insight": "utility",
  "transformation": "buff",
  "aerial_transformation": "combat", 
  "divine_transformation": "magic",
  "mechanical_weapon": "combat",
  "setup_ability": "utility",
  "aerial_invention": "combat",
  "karakuri_summon": "combat",
  "healing_automation": "healing",
  "defensive_automation": "buff"
};

/**
 * Class Mapping from Frontend to Backend
 */
const CLASS_MAPPING = {
  "Armamentista": "Armamentista",
  "Naturalista": "Arcano", // Maps to Arcano since Naturalista isn't in valid classes
  "Art√≠fice": "Lutador", // Maps to Lutador
  "Or√°culo": "Arcano",
  "Nahualli": "Arcano", 
  "Inventor": "Armamentista",
  "Mecanista": "Armamentista"
};

/**
 * Character Skills Data Extracted from Frontend Files
 * Each character has 3 skills with cultural authenticity preserved
 */
const SKILLS_DATA = {
  // Aurelius Ignisvox - Roman Commander Skills
  "aurelius_ignisvox": {
    characterName: "Aurelius Ignisvox",
    characterId: "A9C4N0001E",
    culture: "Romana Imperial",
    classe: "Armamentista",
    element: "Fogo Militar",
    skills: [
      {
        id: "comando_das_legioes_flamejantes",
        name: "üî• Comando das Legi√µes Flamejantes",
        description: "Invoca legi√µes espectrais romanas imbu√≠das com fogo militar",
        type: "combat", // Mapped from command_magic
        element: "military_fire",
        classe: "Armamentista",
        culture: "Romana Imperial",
        characterId: "A9C4N0001E",
        characterName: "Aurelius Ignisvox",
        skillType: "active",
        manaCost: 0,
        animaCost: 0,
        baseDamage: 85,
        baseHealing: 0,
        cooldown: 0,
        castTime: 0,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["centurion_discipline", "military_burn"],
          animation: "legion_charge",
          soundEffect: "war_horns"
        },
        culturalElements: [
          "T√°ticas militares romanas",
          "Forma√ß√µes de combate das legi√µes", 
          "Disciplina e hierarquia militar",
          "Culto imperial e fogo sagrado"
        ],
        balanceData: {
          powerLevel: 85,
          versatility: 7,
          strategicValue: 9
        }
      },
      {
        id: "formacao_testudo_flamejante",
        name: "üõ°Ô∏è Forma√ß√£o Testudo Flamejante", 
        description: "Adota forma√ß√£o defensiva romana com escudos em chamas",
        type: "defensive_formation",
        element: "military_fire",
        classe: "Armamentista",
        culture: "Romana Imperial",
        characterId: "A9C4N0001E",
        characterName: "Aurelius Ignisvox",
        skillType: "active",
        manaCost: 0,
        animaCost: 40,
        baseDamage: 0,
        baseHealing: 15, // 15% HP moral boost
        cooldown: 2,
        castTime: 1,
        range: "self",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["testudo_formation", "flame_counterattack"],
          animation: "testudo_formation",
          soundEffect: "shields_clank"
        },
        culturalElements: [
          "Forma√ß√£o tartaruga das legi√µes",
          "Escudos flamejantes",
          "Contra-ataque militar disciplinado",
          "Moral e resist√™ncia romana"
        ],
        balanceData: {
          powerLevel: 75,
          versatility: 8,
          strategicValue: 10
        }
      },
      {
        id: "gladius_incendium", 
        name: "‚öîÔ∏è Gladius Incendium",
        description: "Ataque preciso com gladius envolvido em chamas sagradas",
        type: "weapon_mastery",
        element: "sacred_fire",
        classe: "Armamentista", 
        culture: "Romana Imperial",
        characterId: "A9C4N0001E",
        characterName: "Aurelius Ignisvox",
        skillType: "active",
        manaCost: 0,
        animaCost: 30,
        baseDamage: 90,
        baseHealing: 0,
        cooldown: 1,
        castTime: 0,
        range: "melee",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["legion_mark"],
          animation: "gladius_thrust", 
          soundEffect: "blade_fire",
          armorPiercing: true,
          criticalChance: 0.25
        },
        culturalElements: [
          "Gladius e t√©cnicas legion√°rias",
          "Precis√£o militar romana",
          "Fogo sagrado imperial",
          "Penetra√ß√£o de armadura"
        ],
        balanceData: {
          powerLevel: 90,
          versatility: 6,
          strategicValue: 7
        }
      }
    ]
  },

  // Shi Wuxing - Chinese Master Skills  
  "shi_wuxing": {
    characterName: "Shi Wuxing",
    characterId: "EA32D10F2D", 
    culture: "Chinesa Imperial",
    classe: "Naturalista",
    element: "Wu Xing (Cinco Elementos)",
    skills: [
      {
        id: "ciclo_dos_cinco_elementos",
        name: "üåä Ciclo dos Cinco Elementos", 
        description: "Rotaciona atrav√©s dos elementos Wu Xing com efeitos √∫nicos",
        type: "elemental_cycle",
        element: "wu_xing",
        classe: "Naturalista",
        culture: "Chinesa Imperial", 
        characterId: "EA32D10F2D",
        characterName: "Shi Wuxing",
        skillType: "active",
        manaCost: 0,
        animaCost: 35,
        baseDamage: 75,
        baseHealing: 20, // Wood element healing
        cooldown: 0,
        castTime: 1,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["elemental_cycle", "wu_xing_mastery"],
          animation: "element_cycle",
          soundEffect: "elemental_harmony"
        },
        culturalElements: [
          "Filosofia Wu Xing (Cinco Elementos)",
          "Ciclo de gera√ß√£o e destrui√ß√£o elemental",
          "Medicina Tradicional Chinesa",
          "Harmonia c√≥smica"
        ],
        balanceData: {
          powerLevel: 75,
          versatility: 10,
          strategicValue: 9
        }
      },
      {
        id: "harmonia_do_yin_yang",
        name: "‚òØÔ∏è Harmonia do Yin Yang",
        description: "Equilibra energia vital entre Shi e o alvo",
        type: "balance_harmony",
        element: "yin_yang", 
        classe: "Naturalista",
        culture: "Chinesa Imperial",
        characterId: "EA32D10F2D",
        characterName: "Shi Wuxing",
        skillType: "active",
        manaCost: 0,
        animaCost: 25,
        baseDamage: 0, // Variable based on HP difference
        baseHealing: 0, // Variable based on HP difference  
        cooldown: 1,
        castTime: 2,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["yin_yang_harmony"],
          animation: "yin_yang_circle",
          soundEffect: "harmony_chimes"
        },
        culturalElements: [
          "Princ√≠pios Yin Yang",
          "Equil√≠brio de energia vital",
          "Filosofia dualista chinesa",
          "Harmonia entre opostos"
        ],
        balanceData: {
          powerLevel: 60,
          versatility: 9,
          strategicValue: 10
        }
      },
      {
        id: "invocacao_do_dragao_imperial",
        name: "üêâ Invoca√ß√£o do Drag√£o Imperial",
        description: "Canaliza o poder do drag√£o chin√™s para ataque devastador",
        type: "dragon_summon",
        element: "imperial_dragon",
        classe: "Naturalista",
        culture: "Chinesa Imperial",
        characterId: "EA32D10F2D", 
        characterName: "Shi Wuxing",
        skillType: "active",
        manaCost: 0,
        animaCost: 60,
        baseDamage: 110,
        baseHealing: 0,
        cooldown: 3,
        castTime: 2,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["dragon_mark", "dragon_intimidation"],
          animation: "imperial_dragon_descent",
          soundEffect: "dragon_roar",
          criticalChance: 0.35
        },
        culturalElements: [
          "Mitologia do Drag√£o Imperial",
          "Poder dos imperadores celestiais", 
          "Intimida√ß√£o drac√¥nica",
          "Marca do poder drac√¥nico"
        ],
        balanceData: {
          powerLevel: 110,
          versatility: 8,
          strategicValue: 9
        }
      }
    ]
  },

  // Milo≈° ≈Ωeleznikov - Slavic Warrior Skills
  "milos_zeleznikov": {
    characterName: "Milo≈° ≈Ωeleznikov",
    characterId: "045CCF3515",
    culture: "Eslava",
    classe: "Art√≠fice", 
    element: "Ferro e Fogo Ancestral",
    skills: [
      {
        id: "forja_do_dragao_eslavo",
        name: "üî® Forja do Drag√£o Eslavo",
        description: "Invoca t√©cnicas ancestrais para forjar arma de escamas de drag√£o",
        type: "weapon_craft",
        element: "fire_metal",
        classe: "Art√≠fice",
        culture: "Eslava",
        characterId: "045CCF3515",
        characterName: "Milo≈° ≈Ωeleznikov", 
        skillType: "active",
        manaCost: 0,
        animaCost: 0,
        baseDamage: 95,
        baseHealing: 0,
        cooldown: 0,
        castTime: 1,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["dragon_weapon", "forge_heat"],
          animation: "forge_hammer",
          soundEffect: "metal_clang"
        },
        culturalElements: [
          "Tradi√ß√µes metal√∫rgicas dos C√°rpatos",
          "Forja draconiana ancestral",
          "Calor crescente da forja",
          "Artesanato eslavo tradicional"
        ],
        balanceData: {
          powerLevel: 95,
          versatility: 7,
          strategicValue: 8
        }
      },
      {
        id: "martelo_dos_ancestrais", 
        name: "‚öíÔ∏è Martelo dos Ancestrais",
        description: "Invoca esp√≠ritos de ferreiros eslavos para guiar o ataque",
        type: "ancestral_summon",
        element: "spirit_metal",
        classe: "Art√≠fice",
        culture: "Eslava", 
        characterId: "045CCF3515",
        characterName: "Milo≈° ≈Ωeleznikov",
        skillType: "active",
        manaCost: 0,
        animaCost: 30,
        baseDamage: 70,
        baseHealing: 0,
        cooldown: 1,
        castTime: 1,
        range: "single_target", 
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["armor_dent"],
          animation: "ancestral_hammer",
          soundEffect: "hammer_echo",
          criticalChance: 0.2
        },
        culturalElements: [
          "Esp√≠ritos ancestrais de ferreiros",
          "Sabedoria metal√∫rgica eslava",
          "Redu√ß√£o de defesa inimiga",
          "Ecos dos martelos ancestrais"
        ],
        balanceData: {
          powerLevel: 70,
          versatility: 6,
          strategicValue: 7
        }
      },
      {
        id: "koljcuga_drakonova",
        name: "üõ°Ô∏è Koljƒçuga Drakonova",
        description: "Forja armadura tempor√°ria de escamas de drag√£o",
        type: "defensive_craft",
        element: "dragon_metal",
        classe: "Art√≠fice",
        culture: "Eslava",
        characterId: "045CCF3515",
        characterName: "Milo≈° ≈Ωeleznikov",
        skillType: "active", 
        manaCost: 0,
        animaCost: 45,
        baseDamage: 0,
        baseHealing: 15, // 15% HP protection boost
        cooldown: 2,
        castTime: 2,
        range: "self",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["dragon_armor"],
          animation: "armor_forge",
          soundEffect: "dragon_scales"
        },
        culturalElements: [
          "Koljƒçuga (cota de malha eslava)",
          "Escamas de drag√£o eslavo",
          "Resist√™ncia m√°gica draconiana", 
          "Prote√ß√£o ancestral"
        ],
        balanceData: {
          powerLevel: 60,
          versatility: 8,
          strategicValue: 9
        }
      }
    ]
  },

  // Pythia Kassandra - Greek Oracle Skills
  "pythia_kassandra": {
    characterName: "Pythia Kassandra",
    characterId: "7A8B9C0D1E",
    culture: "Grega Cl√°ssica",
    classe: "Or√°culo",
    element: "Vis√µes Prof√©ticas",
    skills: [
      {
        id: "visao_oracular_dos_tres_destinos",
        name: "üîÆ Vis√£o Oracular dos Tr√™s Destinos",
        description: "Vislumbra futuros poss√≠veis para alterar o combate",
        type: "prediction",
        element: "divine_sight", 
        classe: "Or√°culo",
        culture: "Grega Cl√°ssica",
        characterId: "7A8B9C0D1E",
        characterName: "Pythia Kassandra",
        skillType: "active",
        manaCost: 0,
        animaCost: 35,
        baseDamage: 70,
        baseHealing: 0,
        cooldown: 0,
        castTime: 2,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["prophetic_doom", "prophetic_fortune", "prophetic_insight"],
          animation: "oracle_vision",
          soundEffect: "prophecy_whispers"
        },
        culturalElements: [
          "Or√°culo de Delfos e tradi√ß√µes prof√©ticas",
          "Tr√™s destinos poss√≠veis",
          "Vis√µes do futuro",
          "Sabedoria oracular ancestral"
        ],
        balanceData: {
          powerLevel: 70,
          versatility: 10,
          strategicValue: 10
        }
      },
      {
        id: "tempestade_profetica_de_delfos",
        name: "üå™Ô∏è Tempestade Prof√©tica de Delfos",
        description: "Invoca os ventos sagrados carregados com fragmentos de profecias",
        type: "divine_storm",
        element: "prophetic_wind",
        classe: "Or√°culo",
        culture: "Grega Cl√°ssica", 
        characterId: "7A8B9C0D1E",
        characterName: "Pythia Kassandra",
        skillType: "active",
        manaCost: 0,
        animaCost: 50,
        baseDamage: 95,
        baseHealing: 0,
        cooldown: 2,
        castTime: 2,
        range: "single_target",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["prophetic_aura"],
          animation: "prophetic_storm", 
          soundEffect: "wind_prophecies",
          multiHit: true
        },
        culturalElements: [
          "Ventos sagrados de Delfos",
          "Fragmentos prof√©ticos m√∫ltiplos",
          "Tempestade de revela√ß√£o divina",
          "Aura prof√©tica ancestral"
        ],
        balanceData: {
          powerLevel: 95,
          versatility: 8,
          strategicValue: 9
        }
      },
      {
        id: "olho_de_apolo",
        name: "üëÅÔ∏è Olho de Apolo", 
        description: "Canaliza a vis√£o do deus para revelar e explorar todas as fraquezas",
        type: "divine_insight",
        element: "solar_sight",
        classe: "Or√°culo",
        culture: "Grega Cl√°ssica",
        characterId: "7A8B9C0D1E",
        characterName: "Pythia Kassandra",
        skillType: "active",
        manaCost: 0,
        animaCost: 25,
        baseDamage: 0,
        baseHealing: 0,
        cooldown: 3,
        castTime: 1,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["divine_sight", "analyzed"],
          animation: "divine_eye_opening",
          soundEffect: "apollo_blessing"
        },
        culturalElements: [
          "Apolo - Deus da Profecia e Luz",
          "Vis√£o divina completa",
          "An√°lise anat√¥mica divina", 
          "Revela√ß√£o de fraquezas"
        ],
        balanceData: {
          powerLevel: 50,
          versatility: 9,
          strategicValue: 10
        }
      }
    ]
  },

  // Itzel Nahualli - Aztec Shaman Skills
  "itzel_nahualli": {
    characterName: "Itzel Nahualli",
    characterId: "2F3E4D5C6B",
    culture: "Azteca/Mexica",
    classe: "Nahualli", 
    element: "Transforma√ß√£o Espiritual",
    skills: [
      {
        id: "metamorfose_do_ocelotl",
        name: "üêÜ Metamorfose do Ocelotl",
        description: "Transforma-se na forma sagrada do jaguar das sombras",
        type: "transformation",
        element: "shadow_spirit",
        classe: "Nahualli",
        culture: "Azteca/Mexica",
        characterId: "2F3E4D5C6B",
        characterName: "Itzel Nahualli",
        skillType: "active",
        manaCost: 0,
        animaCost: 35,
        baseDamage: 80,
        baseHealing: 0,
        cooldown: 1,
        castTime: 1,
        range: "single_target",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["ocelotl_form", "primal_fear"],
          animation: "jaguar_transformation",
          soundEffect: "jaguar_growl"
        },
        culturalElements: [
          "Nahualismo e xamanismo mexica",
          "Transforma√ß√£o em jaguar sagrado",
          "Sombras e furtividade felina",
          "Medo primal do predador"
        ],
        balanceData: {
          powerLevel: 80,
          versatility: 8,
          strategicValue: 8
        }
      },
      {
        id: "voo_da_aguia_dourada", 
        name: "ü¶Ö Voo da √Åguia Dourada",
        description: "Transforma-se em √°guia e ataca do c√©u com precis√£o divina",
        type: "aerial_transformation",
        element: "wind_spirit",
        classe: "Nahualli",
        culture: "Azteca/Mexica",
        characterId: "2F3E4D5C6B",
        characterName: "Itzel Nahualli",
        skillType: "active",
        manaCost: 0, 
        animaCost: 40,
        baseDamage: 75,
        baseHealing: 0,
        cooldown: 2,
        castTime: 1,
        range: "single_target",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["cuauhtli_form", "sacred_wind"],
          animation: "eagle_dive",
          soundEffect: "eagle_cry"
        },
        culturalElements: [
          "Cuauhtli (√°guia dourada sagrada)",
          "Voo divino e precis√£o a√©rea", 
          "Ventos sagrados dos c√©us",
          "Vis√£o agu√ßada da √°guia"
        ],
        balanceData: {
          powerLevel: 75,
          versatility: 9,
          strategicValue: 8
        }
      },
      {
        id: "serpente_emplumada",
        name: "üêç Serpente Emplumada",
        description: "Canaliza o poder de Quetzalcoatl atrav√©s de transforma√ß√£o serpentina",
        type: "divine_transformation", 
        element: "feathered_serpent",
        classe: "Nahualli",
        culture: "Azteca/Mexica",
        characterId: "2F3E4D5C6B",
        characterName: "Itzel Nahualli",
        skillType: "active",
        manaCost: 0,
        animaCost: 45,
        baseDamage: 60,
        baseHealing: 12, // Group healing
        cooldown: 2,
        castTime: 2,
        range: "single_target",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["coatl_wisdom", "sacred_venom", "ancestral_foresight"],
          animation: "serpent_coil",
          soundEffect: "serpent_hiss"
        },
        culturalElements: [
          "Quetzalcoatl - Serpente Emplumada",
          "Sabedoria divina e cura grupal",
          "Veneno sagrado n√£o-letal", 
          "Premoni√ß√£o ancestral"
        ],
        balanceData: {
          powerLevel: 60,
          versatility: 10,
          strategicValue: 10
        }
      }
    ]
  },

  // Giovanni da Ferrara - Italian Artisan Skills
  "giovanni_da_ferrara": {
    characterName: "Giovanni da Ferrara",
    characterId: "9A8B7C6D5E",
    culture: "Italiana Renascentista",
    classe: "Inventor",
    element: "Engenharia Mec√¢nica",
    skills: [
      {
        id: "balista_da_precisao_florentina",
        name: "‚öôÔ∏è Balista da Precis√£o Florentina",
        description: "Dispara proj√©til de precis√£o usando engenharia avan√ßada",
        type: "mechanical_weapon",
        element: "engineering",
        classe: "Inventor",
        culture: "Italiana Renascentista", 
        characterId: "9A8B7C6D5E",
        characterName: "Giovanni da Ferrara",
        skillType: "active",
        manaCost: 0,
        animaCost: 25,
        baseDamage: 100,
        baseHealing: 0,
        cooldown: 1,
        castTime: 1,
        range: "ranged",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["ballista_setup", "vital_point_marked"],
          animation: "ballista_shot",
          soundEffect: "crossbow_release",
          multiShot: true
        },
        culturalElements: [
          "Engenharia renascentista italiana",
          "Precis√£o florentina artesanal",
          "Estudo anat√¥mico cient√≠fico",
          "Bal√≠stica e mecanismos"
        ],
        balanceData: {
          powerLevel: 100,
          versatility: 7,
          strategicValue: 8
        }
      },
      {
        id: "oficina_portatil_renascentista",
        name: "üõ†Ô∏è Oficina Port√°til Renascentista", 
        description: "Monta uma oficina tempor√°ria para criar dispositivos em batalha",
        type: "setup_ability",
        element: "creative_engineering",
        classe: "Inventor",
        culture: "Italiana Renascentista",
        characterId: "9A8B7C6D5E",
        characterName: "Giovanni da Ferrara",
        skillType: "active",
        manaCost: 0,
        animaCost: 50,
        baseDamage: 0,
        baseHealing: 20, // Inspiration healing
        cooldown: 3,
        castTime: 2,
        range: "area",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["renaissance_workshop", "smoke_concealment", "renaissance_inspiration"],
          animation: "workshop_assembly",
          soundEffect: "workshop_sounds"
        },
        culturalElements: [
          "Oficinas renascentistas",
          "Genialidade inventiva italiana",
          "Dispositivos m√∫ltiplos criados",
          "Inspira√ß√£o para o grupo"
        ],
        balanceData: {
          powerLevel: 70,
          versatility: 10,
          strategicValue: 10
        }
      },
      {
        id: "maquina_voadora_de_leonardo",
        name: "üé® M√°quina Voadora de Leonardo",
        description: "Voa temporariamente usando prot√≥tipo baseado nos estudos de da Vinci",
        type: "aerial_invention",
        element: "renaissance_flight",
        classe: "Inventor", 
        culture: "Italiana Renascentista",
        characterId: "9A8B7C6D5E", 
        characterName: "Giovanni da Ferrara",
        skillType: "active",
        manaCost: 0,
        animaCost: 60,
        baseDamage: 90,
        baseHealing: 0,
        cooldown: 2,
        castTime: 2,
        range: "aerial",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["leonardo_flight", "aerial_stun", "anatomical_study"],
          animation: "leonardo_flight",
          soundEffect: "wind_wings"
        },
        culturalElements: [
          "Estudos de Leonardo da Vinci",
          "M√°quina voadora renascentista",
          "Ataque de mergulho a√©reo",
          "Estudo anat√¥mico do alto"
        ],
        balanceData: {
          powerLevel: 90,
          versatility: 9, 
          strategicValue: 9
        }
      }
    ]
  },

  // Yamazaki Karakuri - Japanese Engineer Skills
  "yamazaki_karakuri": {
    characterName: "Yamazaki Karakuri",
    characterId: "4F3E2D1C0B",
    culture: "Japonesa Edo",
    classe: "Mecanista",
    element: "Engenharia Precisa",
    skills: [
      {
        id: "invocacao_do_karakuri_kyudo",
        name: "‚öôÔ∏è Invoca√ß√£o do Karakuri Ky≈´d≈ç",
        description: "Constr√≥i e ativa aut√¥mato arqueiro de precis√£o extrema",
        type: "karakuri_summon",
        element: "mechanical_precision",
        classe: "Mecanista",
        culture: "Japonesa Edo", 
        characterId: "4F3E2D1C0B",
        characterName: "Yamazaki Karakuri",
        skillType: "active",
        manaCost: 0,
        animaCost: 40,
        baseDamage: 85,
        baseHealing: 0,
        cooldown: 2,
        castTime: 1,
        range: "ranged",
        areaEffect: false,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["karakuri_archer", "precision_marked"],
          animation: "karakuri_archery",
          soundEffect: "bow_mechanism",
          criticalChance: 0.65,
          doubleShot: true
        },
        culturalElements: [
          "Tradi√ß√£o japonesa de aut√¥matos Karakuri",
          "Ky≈´d≈ç (arte do arco japonesa)", 
          "Precis√£o mec√¢nica extrema",
          "Harmonia entre engrenagens"
        ],
        balanceData: {
          powerLevel: 85,
          versatility: 8,
          strategicValue: 9
        }
      },
      {
        id: "ritual_do_karakuri_chado",
        name: "üçµ Ritual do Karakuri Chad≈ç",
        description: "Ativa aut√¥mato servo do ch√° que cura e harmoniza o grupo",
        type: "healing_automation",
        element: "harmonious_service",
        classe: "Mecanista",
        culture: "Japonesa Edo",
        characterId: "4F3E2D1C0B",
        characterName: "Yamazaki Karakuri",
        skillType: "active",
        manaCost: 0,
        animaCost: 35,
        baseDamage: 0,
        baseHealing: 25, // Base + group healing
        cooldown: 2,
        castTime: 2,
        range: "area",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["chado_serenity", "group_harmony"],
          animation: "tea_ceremony",
          soundEffect: "tea_pouring",
          purification: true
        },
        culturalElements: [
          "Cerim√¥nia do ch√° (Chad≈ç)",
          "Aut√¥mato servo tradicional", 
          "Harmonia do grupo",
          "Purifica√ß√£o e serenidade"
        ],
        balanceData: {
          powerLevel: 60,
          versatility: 9,
          strategicValue: 10
        }
      },
      {
        id: "defesa_do_karakuri_bushi",
        name: "üõ°Ô∏è Defesa do Karakuri Bushi",
        description: "Ativa aut√¥mato guerreiro para prote√ß√£o e contra-ataques",
        type: "defensive_automation",
        element: "protective_mechanism",
        classe: "Mecanista",
        culture: "Japonesa Edo",
        characterId: "4F3E2D1C0B", 
        characterName: "Yamazaki Karakuri",
        skillType: "active",
        manaCost: 0,
        animaCost: 50,
        baseDamage: 70,
        baseHealing: 0,
        cooldown: 3,
        castTime: 1,
        range: "area",
        areaEffect: true,
        requirements: {
          level: 1,
          prerequisites: []
        },
        effects: {
          statusEffects: ["karakuri_defense", "defensive_mark", "bushi_protection", "karakuri_coordination"],
          animation: "bushi_stance",
          soundEffect: "armor_clank",
          counterChance: 0.4
        },
        culturalElements: [
          "Bushid≈ç e esp√≠rito guerreiro",
          "Karakuri Bushi (aut√¥mato samurai)", 
          "Prote√ß√£o coordenada do grupo",
          "Contra-ataques mec√¢nicos"
        ],
        balanceData: {
          powerLevel: 70,
          versatility: 8,
          strategicValue: 10
        }
      }
    ]
  }
};

/**
 * Utility Functions
 */
async function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function makeApiCall(url, options = {}) {
  const defaultOptions = {
    headers: {
      'Content-Type': 'application/json',
      'User-Agent': 'RPGStack-Migration-Script/1.0'
    }
  };

  const mergedOptions = { ...defaultOptions, ...options };
  
  try {
    const response = await fetch(url, mergedOptions);
    const data = await response.json();
    
    return {
      success: response.ok,
      status: response.status,
      data: data
    };
  } catch (error) {
    console.error(`API call failed for ${url}:`, error.message);
    return {
      success: false,
      status: 0,
      error: error.message
    };
  }
}

async function retryApiCall(url, options, maxRetries = CONFIG.retryAttempts) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    console.log(`  Attempt ${attempt}/${maxRetries}...`);
    
    const result = await makeApiCall(url, options);
    
    if (result.success) {
      return result;
    }
    
    lastError = result;
    
    if (attempt < maxRetries) {
      console.log(`  Failed, retrying in ${CONFIG.retryDelay}ms...`);
      await delay(CONFIG.retryDelay);
    }
  }
  
  return lastError;
}

/**
 * Validation Functions
 */
function validateSkillData(skill) {
  const required = ['id', 'name', 'description', 'type', 'characterId', 'characterName'];
  const missing = required.filter(field => !skill[field]);
  
  if (missing.length > 0) {
    return {
      valid: false,
      errors: [`Missing required fields: ${missing.join(', ')}`]
    };
  }
  
  // Additional validation
  const errors = [];
  
  if (typeof skill.baseDamage !== 'number' || skill.baseDamage < 0) {
    errors.push('baseDamage must be a non-negative number');
  }
  
  if (typeof skill.animaCost !== 'number' || skill.animaCost < 0) {
    errors.push('animaCost must be a non-negative number');
  }
  
  if (typeof skill.cooldown !== 'number' || skill.cooldown < 0) {
    errors.push('cooldown must be a non-negative number');
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}

/**
 * Migration Functions
 */
async function checkApiConnection() {
  console.log('üîç Checking API connection...');
  
  const result = await makeApiCall(`${API_BASE_URL}/test`);
  
  if (result.success) {
    console.log('‚úÖ API connection established');
    console.log(`   Server: ${result.data.message}`);
    return true;
  } else {
    console.error('‚ùå Failed to connect to API');
    console.error(`   Status: ${result.status}`);
    console.error(`   Error: ${result.error || result.data?.error || 'Unknown error'}`);
    return false;
  }
}

async function backupExistingSkills() {
  if (!CONFIG.backupExisting) {
    return { success: true };
  }
  
  console.log('üíæ Creating backup of existing skills...');
  
  const result = await makeApiCall(SKILLS_ENDPOINT);
  
  if (result.success) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupPath = path.join(__dirname, `skills_backup_${timestamp}.json`);
    
    try {
      await fs.writeFile(backupPath, JSON.stringify(result.data, null, 2));
      console.log(`‚úÖ Backup created: ${backupPath}`);
      return { success: true, backupPath };
    } catch (error) {
      console.error('‚ùå Failed to create backup file:', error.message);
      return { success: false, error: error.message };
    }
  } else {
    console.log('‚ö†Ô∏è  No existing skills found to backup');
    return { success: true };
  }
}

/**
 * Transform skill data to match backend requirements
 */
function transformSkillData(skill) {
  const transformed = { ...skill };
  
  // Map skill type to valid backend type
  if (skill.type && SKILL_TYPE_MAPPING[skill.type]) {
    transformed.type = SKILL_TYPE_MAPPING[skill.type];
  }
  
  // Map classe to valid backend classe
  if (skill.classe && CLASS_MAPPING[skill.classe]) {
    transformed.classe = CLASS_MAPPING[skill.classe];
  }
  
  // Ensure required fields have default values
  transformed.level = transformed.level || 1;
  transformed.damage = transformed.baseDamage || 0;
  transformed.healing = transformed.baseHealing || 0;
  transformed.manaCost = transformed.manaCost || 0;
  transformed.cooldown = transformed.cooldown || 0;
  
  // Remove any undefined or null values
  Object.keys(transformed).forEach(key => {
    if (transformed[key] === undefined || transformed[key] === null) {
      delete transformed[key];
    }
  });
  
  return transformed;
}

async function migrateSkill(skill) {
  // Transform skill data to match backend requirements
  const transformedSkill = transformSkillData(skill);
  
  if (CONFIG.validateData) {
    const validation = validateSkillData(transformedSkill);
    if (!validation.valid) {
      return {
        success: false,
        skill: transformedSkill,
        errors: validation.errors
      };
    }
  }
  
  const result = await retryApiCall(SKILLS_ENDPOINT, {
    method: 'POST',
    body: JSON.stringify(transformedSkill)
  });
  
  return {
    success: result.success,
    skill: transformedSkill,
    response: result.data,
    errors: result.success ? [] : [result.error || result.data?.error || 'Unknown error']
  };
}

async function migrateAllSkills() {
  console.log('üéØ Starting skills migration...\n');
  
  const results = {
    total: 0,
    successful: 0,
    failed: 0,
    details: []
  };
  
  // Count total skills
  for (const characterData of Object.values(SKILLS_DATA)) {
    results.total += characterData.skills.length;
  }
  
  console.log(`üìä Total skills to migrate: ${results.total}`);
  
  // Process each character's skills
  for (const [characterKey, characterData] of Object.entries(SKILLS_DATA)) {
    console.log(`\nüé≠ Processing ${characterData.characterName} (${characterData.culture})`);
    console.log(`   ${characterData.skills.length} skills to migrate:`);
    
    for (const skill of characterData.skills) {
      console.log(`\n   üîÆ Migrating: ${skill.name}`);
      
      const result = await migrateSkill(skill);
      results.details.push(result);
      
      if (result.success) {
        results.successful++;
        console.log(`   ‚úÖ Success: ${skill.name}`);
        if (result.response?.metadata) {
          console.log(`      Skill ID: ${result.response.data?.skill?.id || 'Generated'}`);
        }
      } else {
        results.failed++;
        console.log(`   ‚ùå Failed: ${skill.name}`);
        console.log(`      Errors: ${result.errors.join(', ')}`);
      }
      
      // Small delay to prevent overwhelming the API
      await delay(100);
    }
  }
  
  return results;
}

async function verifyMigration() {
  console.log('\nüîç Verifying migration...');
  
  const result = await makeApiCall(SKILLS_ENDPOINT);
  
  if (result.success) {
    const skillsData = result.data;
    console.log(`‚úÖ Migration verified:`);
    console.log(`   Total skills in database: ${skillsData.data?.totalCount || skillsData.data?.skills?.length || 0}`);
    
    if (skillsData.data?.skills) {
      const skillsByCharacter = {};
      skillsData.data.skills.forEach(skill => {
        if (!skillsByCharacter[skill.characterName]) {
          skillsByCharacter[skill.characterName] = [];
        }
        skillsByCharacter[skill.characterName].push(skill);
      });
      
      console.log(`   Skills by character:`);
      for (const [character, skills] of Object.entries(skillsByCharacter)) {
        console.log(`     ${character}: ${skills.length} skills`);
      }
    }
    
    return { success: true, data: skillsData.data };
  } else {
    console.error('‚ùå Failed to verify migration');
    return { success: false, error: result.error };
  }
}

/**
 * Main Migration Process
 */
async function main() {
  console.log(`
üé≠ RPGStack Skills Migration Script
===================================

This script will migrate ${Object.keys(SKILLS_DATA).length} characters' skills 
from frontend JavaScript files to the backend API.

Configuration:
- API Base URL: ${API_BASE_URL}
- Batch Size: ${CONFIG.batchSize}
- Retry Attempts: ${CONFIG.retryAttempts}
- Validate Data: ${CONFIG.validateData}
- Create Backup: ${CONFIG.backupExisting}
`);

  try {
    // Step 1: Check API connection
    const apiConnected = await checkApiConnection();
    if (!apiConnected) {
      console.error('\n‚ùå Cannot proceed without API connection');
      process.exit(1);
    }
    
    // Step 2: Backup existing data
    const backup = await backupExistingSkills();
    if (!backup.success) {
      console.error('\n‚ùå Backup failed:', backup.error);
      process.exit(1);
    }
    
    // Step 3: Migrate skills
    const migrationResults = await migrateAllSkills();
    
    // Step 4: Print summary
    console.log(`
üìã Migration Summary
===================
Total Skills: ${migrationResults.total}
Successful: ${migrationResults.successful} ‚úÖ
Failed: ${migrationResults.failed} ‚ùå
Success Rate: ${((migrationResults.successful / migrationResults.total) * 100).toFixed(1)}%
`);
    
    if (migrationResults.failed > 0) {
      console.log('\n‚ùå Failed Skills:');
      migrationResults.details
        .filter(result => !result.success)
        .forEach(result => {
          console.log(`   ‚Ä¢ ${result.skill.name}: ${result.errors.join(', ')}`);
        });
    }
    
    // Step 5: Verify migration
    const verification = await verifyMigration();
    
    if (verification.success && migrationResults.successful > 0) {
      console.log(`
üéâ Migration completed successfully!

The skills have been registered in the backend and are now available via:
- GET ${SKILLS_ENDPOINT} (list all skills)
- GET ${SKILLS_ENDPOINT}/search?q=<term> (search skills)  
- GET ${SKILLS_ENDPOINT}/type/<type> (skills by type)
- GET ${SKILLS_ENDPOINT}/classe/<classe> (skills by class)
- GET ${SKILLS_ENDPOINT}/statistics (skill statistics)

Each character now has their 3 culturally authentic skills properly
registered with the backend Skills API system.
`);
    } else if (migrationResults.successful === 0) {
      console.error('\n‚ùå Migration failed completely. No skills were registered.');
      process.exit(1);
    } else {
      console.log('\n‚ö†Ô∏è  Partial migration completed. Some skills may not be available.');
    }
    
  } catch (error) {
    console.error('\nüí• Migration script error:', error.message);
    console.error('Stack trace:', error.stack);
    process.exit(1);
  }
}

// Execute migration
if (import.meta.url === `file://${__filename}`) {
  main().catch(error => {
    console.error('Unhandled error:', error);
    process.exit(1);
  });
}

export { SKILLS_DATA, migrateAllSkills };